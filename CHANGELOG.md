# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Changed
- **Documentation Consolidation**
  - Merged SPEC.md content into ARCHITECTURE.md
  - Catalog and config schemas now in ARCHITECTURE.md reference sections
  - Removed duplicated content (commands, workflows)
  - All references updated across documentation
- **Simplified Cache Structure**
  - Changed from 4-level to 2-level cache directory structure
  - Old: `~/.local/share/shelfctl/cache/<owner>/<repo>/<bookID>/<file>`
  - New: `~/.local/share/shelfctl/cache/<repo>/<file>`
  - Makes browsing cached books easier in Finder/Explorer
  - Reduces unnecessary nesting for personal library use
  - **Migration**: If upgrading from an older version, you can safely delete your old cache directory and books will re-download with the new structure:
    ```bash
    rm -rf ~/.local/share/shelfctl/cache
    ```

### Added
- **Book Edit Command**
  - New `edit-book` command for updating book metadata
  - Interactive TUI form when no flags provided
  - CLI flags for scripted updates: `--title`, `--author`, `--year`, `--add-tag`, `--rm-tag`
  - Pre-populates form with current metadata values
  - Updates catalog.yml in GitHub without touching the asset file
  - Supports adding/removing tags incrementally (no need to re-enter all tags)
  - Added to hub menu as "Edit Book" option
  - Filtered from menu when no books exist
  - Completes full CRUD: Create (shelve), Read (browse/info), Update (edit-book), Delete (delete-book)
  - Editable fields: title, author, year, tags
  - Non-editable fields: ID, format, checksum, asset (tied to the file)
- **Book Deletion Command**
  - New `delete-book` command for removing books from library
  - Interactive book picker when no ID provided
  - Deletes both release asset and catalog entry
  - Clears from local cache automatically
  - Requires confirmation (type book ID to confirm)
  - Added to hub menu as "Delete Book" option
  - Filtered from menu when no books exist
  - Completes CRUD operations: Create (shelve), Read (browse), Update (move), Delete (delete-book)
- **Fully Interactive Book Browser**
  - `browse` command now supports real-time actions:
    - `tab` - Toggle split-panel details view
    - `enter` - Show detailed book information (or perform action if details visible)
    - `o` - Open book (downloads if needed, opens with system viewer)
    - `g` - Download to cache only (for offline access)
    - `q` - Quit browser
  - Split-panel layout shows book metadata in right pane
    - ID, title, author, tags, shelf name, repository, cache status, format, asset name
    - Uses master wrapper pattern: compose panels first, then apply single outer border
    - Cleaner visual separation with vertical divider between panels
    - Responsive sizing based on terminal dimensions
    - Single rounded border wraps entire layout (no double borders)
    - Automatically adjusts list width (60%) and details width (40%) when panel visible
  - Auto-downloads books when opening if not cached
  - Shows download progress with file size
  - Displays full metadata on demand
  - All actions work seamlessly from TUI
- **Interactive Progress Bars**
  - Visual progress tracking for downloads and uploads in TTY mode
  - Shows real-time progress with bytes transferred and percentage
  - Clean progress bar UI using Bubble Tea and bubbles/progress
  - Displays file size and estimated completion
  - Used in:
    - `open` command when downloading books
    - `browse` command when downloading (actions 'o' and 'g')
    - `shelve` command when uploading assets
  - Automatically disabled in non-interactive mode (pipes, redirects, scripts)
  - Preserves existing text output for automation
- **Hub Loop Implementation**
  - Hub menu now loops continuously until user quits
  - Returns to menu after command completion
  - Shows "Press Enter to return to menu..." prompt
  - Reloads config after operations to reflect changes
  - Handles errors gracefully with option to retry
  - No more dropped back to shell after single operation
- **Enhanced Interactive Init**
  - Detects and handles existing repositories gracefully
  - Prompts to use existing repo or enter different name
  - Interactive public/private repository visibility choice
  - Shows visibility in summary before creation
  - Skips README creation if already exists
  - Checks for duplicate shelf names in config
  - Returns to hub menu after successful init (not back to shell)
- **Improved Delete Shelf Flow**
  - Interactive prompt: "What should happen to the GitHub repository?"
  - Clear numbered choices with explanations
  - Option 1: Keep repo (remove from config only)
  - Option 2: Delete permanently (repository and all books)
  - Visual warnings with color-coded dangerous operations
  - Shows exactly what will be deleted before confirmation
- **Smart Hub Menu Filtering**
  - Hides shelf-related options when no shelves configured
  - Hides "Browse Library" when no books exist
  - Hides "Delete Book" when no books exist
  - Shows appropriate first-time setup guidance
  - Menu always shows only available actions
- **Repository Visibility Control**
  - `--private` flag for `init` command (default: true)
  - Interactive prompt during init workflow
  - Clear explanations of public vs private
  - Visibility shown in summary before creation
- **Reusable TUI Components**
  - `tui.RunBookPicker()` - Selectable book list
  - `tui.BrowserAction` - Action result types
  - `tui.BrowserResult` - Structured action results
  - Components can be reused across features
- **PDF Metadata Extraction (Stdlib Only)**
  - Automatically extracts Title, Author, and Subject from PDFs
  - Pre-populates form fields when adding books
  - Uses only Go stdlib (no external dependencies)
  - Best-effort parsing - works for most PDFs with metadata
  - Handles both parentheses format and UTF-16BE hex format
  - Gracefully handles PDFs without metadata (falls back to filename)
  - Supports standard PDF string escaping
  - Zero binary size increase
  - Significantly improves UX for academic papers and published books
  - Tested with real-world PDFs

### Added
- **Comprehensive Architecture Documentation**
  - New `docs/ARCHITECTURE.md` guide covering:
    - Core concepts (shelves, catalogs, assets)
    - Organization philosophy (start broad, split later)
    - When to create multiple shelves vs using tags/releases
    - Naming conventions and best practices
    - Splitting strategies and scaling guidelines
    - Common patterns for different use cases
    - Migration strategies from existing repos
    - Decision trees and GitHub limits
  - Linked from README.md and docs/index.md
  - Referenced inline during interactive init
- **Automatic README.md Generation for Shelves**
  - Each shelf now gets a README.md created automatically during init
  - Template includes:
    - Shelf description and quick stats (book count, last updated)
    - Usage examples for adding and browsing books
    - Organization sections (by topic, reading lists, favorites)
    - Maintenance commands reference
    - Links to documentation and releases
  - Auto-updates on each book addition:
    - Updates book count and last updated date
    - Adds book to "Recently Added" section
    - Non-intrusive: won't fail if README is customized
  - Makes each shelf look professional on GitHub
  - Provides human-readable inventory alongside catalog.yml
- **Interactive Hub (Phase 1 Complete)**
  - Launch `shelfctl` with no arguments to get an interactive menu
  - Visual dashboard showing all available operations
  - Status bar displaying shelf count and total books
  - Keyboard navigation with ↑/↓ or j/k
  - Search/filter with `/`
  - Smart first-time setup guidance:
    - Visual status check (✓/✗) for token and shelves
    - Detects what's missing and shows specific next steps
    - Offers guided interactive init workflow
    - Inline architecture help with 'help' or '?' at any prompt
    - Clear distinction between repository name and shelf name
    - Example commands showing how shelf name is used
    - Smart defaults calculated from repository name
    - Enhanced summary confirmation with visual formatting
  - Clean focused menu showing only available features
  - Currently provides: Browse Library, Add Book, Quit
  - Additional commands accessible via direct invocation
  - No "coming soon" clutter - menu feels complete
- **Interactive TUI mode using Bubble Tea library**
  - `browse` command: Interactive browser with keyboard navigation, filtering, and search
  - `shelve` command: Fully guided workflow with no arguments required
    - Shelf picker (if multiple shelves)
    - File browser (starts in ~/Downloads, filters for .pdf/.epub/.mobi/.djvu)
    - Metadata form (title, author, tags, ID)
  - Auto-detects terminal vs piped/scripted output
  - New `--no-interactive` global flag to disable TUI mode
  - All TUI components use alt screen and restore terminal state on exit
- Comprehensive documentation
  - `config.example.yml`: Template configuration with detailed comments
  - `CONTRIBUTING.md`: Development setup, testing, and PR guidelines
  - `docs/COMMANDS.md`: Complete command reference with examples
  - `docs/TUTORIAL.md`: Step-by-step walkthrough from installation to workflows
  - `docs/TROUBLESHOOTING.md`: Common issues and solutions
  - `docs/ARCHITECTURE.md`: Organization guide with schemas and configuration reference
  - `docs/index.md`: Documentation home page
- Defensive measures for duplicate content detection
  - `shelve` checks for SHA256 duplicates before upload
  - `shelve` checks for asset name collisions before upload
  - `--force` flag to bypass checks and overwrite existing assets

### Changed
- **README Copy Improvements**
  - Rewrote intro section for better clarity and scannability
  - Enhanced "Why" section with clear headers and bullet points
  - Improved "How it works" section with detailed explanations
  - More conversational and direct tone throughout
  - Added visual hierarchy for easier scanning
- **Hub Menu Organization**
  - Added "Delete Book" option between "Add Book" and "Delete Shelf"
  - Logical grouping: Browse → Add → Delete Book → Delete Shelf → Quit
  - Dynamic filtering based on application state
- **Book Browser Return Type**
  - Changed from simple error return to structured `BrowserResult`
  - Returns selected book and action for processing
  - Enables interactive actions within browser
  - Cleaner separation of concerns
- **BREAKING: Command renames for end-user clarity**
  - `list` → `browse` (better matches interactive TUI functionality)
  - `add` → `shelve` (stronger library metaphor)
  - `get` removed (use `open` - it auto-downloads when needed)
  - All documentation and examples updated to reflect new names
- **README improvements**
  - Fixed factual claims about GitHub limits (removed "1TB+", "2GB storage" specifics)
  - Reordered "Why" section: on-demand first, then Git LFS comparison
  - Clarified API-based operation (no local repos required, run from anywhere)
  - Added logo2.png above Commands section
- **Documentation structure**
  - Moved all docs to `docs/` directory
  - Created navigation structure for doc generators
  - Updated all cross-references
- **Operations made safer**
  - `shelve` loads catalog once for both duplicate checks and appending
  - Clearer error messages for duplicates
  - Force mode explicitly deletes existing assets before re-uploading
  - `open` command inlines download logic (previously called `get`)

### Fixed
- **Shelf README Duplicate Entries**
  - Fixed bug where books appeared multiple times in "Recently Added" section
  - Now checks for existing entries before adding to prevent duplicates
  - Implements 10-entry limit as originally intended
  - Updates book position when re-adding instead of creating duplicates
- **CI golangci-lint Version**
  - Updated GitHub Actions workflow to use golangci-lint v2
  - Fixes CI failures due to v1/v2 configuration mismatch
- **Config Reload After Hub Commands**
  - Fixed stale config bug where deleted shelves still appeared in menu
  - Config now reloads from disk after each successful command
  - Ensures menu reflects current state (added/removed shelves)
  - Prevents "not found" errors on subsequent operations
- **Linter Compliance**
  - Fixed all `errcheck` issues (ignored return values)
  - Fixed `revive` var-naming issues (renamed `select_` to `selectItem`)
  - Fixed `ineffassign` issues (proper variable initialization)
  - Fixed exported function documentation
  - Fixed error string capitalization
  - All code passes golangci-lint with project configuration
- **File Picker Permission Handling**
  - Gracefully handles permission denied errors
  - Shows parent directory (..) when access denied
  - Changed starting directory from Downloads to current working directory
  - No longer crashes on permission errors
- **Delete Shelf Repository Confusion**
  - Changed wording from "Delete repository?" to numbered choices
  - Clear explanation of what each option does
  - Prevents accidental permanent deletion
  - Shows exactly what will happen before confirmation
- **Cyclomatic Complexity**
  - Refactored 7 high-complexity functions
  - Extracted helper functions for better maintainability
  - `shelve.go`: 35 → ~10 (12 helpers)
  - `move.go`: 31 → ~8 (7 helpers)
  - `import.go`: 28 → ~10 (7 helpers)
  - `split.go`: 27 → ~12 (5 helpers)
  - `init.go`: 22 → ~8 (6 helpers)
  - `migrate.go`: 22 & 19 → ~10 & ~8 (9 helpers)

## [0.1.0] - 2024-02-20

### Added
- Initial implementation of shelfctl
- GitHub releases as storage backend for document libraries
- Core commands: init, add, list, info, get, open, move, split, migrate, import
- Catalog-based metadata management with YAML
- Local cache for downloaded files with SHA256 verification
- Support for multiple shelf repos per user
- Flexible asset naming strategies (id-based or original filename)
- Migration tools for importing from existing repos
- Import command with SHA256-based duplicate detection
- Test suite with coverage: cache 72.7%, catalog 74.2%, util 71.9%, ingest 40.3%, migrate 49.4%, app 12.4%

[Unreleased]: https://github.com/blackwell-systems/shelfctl/compare/v0.1.0...HEAD
[0.1.0]: https://github.com/blackwell-systems/shelfctl/releases/tag/v0.1.0
